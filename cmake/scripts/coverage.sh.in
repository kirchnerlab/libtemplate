#!/bin/bash

cd @LIBTEMPLATE_BINARY_DIR@

make test

mkdir -p @LIBTEMPLATE_BINARY_DIR@/coverage

#check if gcovr exists
hash gcovr &> /dev/null
if [ $? -eq 1 ]; 
	then     echo >&2 "gcovr not found. Therfore no xml coverage output can be generated"; 
else
	gcovr -r @LIBTEMPLATE_BINARY_DIR@ -f '.*libtemplate' -e '.*test' -x > @LIBTEMPLATE_BINARY_DIR@/coverage/coverage.xml
fi

#check if genhtml exists
hash genhtml &> /dev/null
if [ $? -eq 1 ]; 
	then     echo >&2 "genhtml not found. Therfore no html coverage output can be generated"; 
else

	lcov --directory @LIBTEMPLATE_BINARY_DIR@/test/CMakeFiles \
	     --directory @LIBTEMPLATE_BINARY_DIR@/src/CMakeFiles/template.dir \
	     --directory @LIBTEMPLATE_BINARY_DIR@/src/CMakeFiles \
	     -capture --output-file @LIBTEMPLATE_BINARY_DIR@/coverage/template.info
	lcov --extract @LIBTEMPLATE_BINARY_DIR@/coverage/template.info '*libtemplate*' -o @LIBTEMPLATE_BINARY_DIR@/coverage/template.info.extracted
	lcov --remove @LIBTEMPLATE_BINARY_DIR@/coverage/template.info.extracted '*test*' -o @LIBTEMPLATE_BINARY_DIR@/coverage/template.info.extracted2
	pushd @LIBTEMPLATE_BINARY_DIR@/coverage/
	genhtml --demangle-cpp --legend --show-details template.info.extracted2
	popd
fi
 
 
